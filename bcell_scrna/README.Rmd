---
title: "CITE-seq Pilots"
output: github_document
---

```{r setup, include=FALSE}
unix::rlimit_as(1e12)

library(knitr)
opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, comment = "#",
               dpi = 300)
options(width = 999)
```

```{r, echo=FALSE}
# single-cell data analysis
library(Seurat)
library(miQC)
library(scater)
library(cluster)

# Data wrangling
library(tidyverse)

# Plotting
library(tidytext)
library(ggridges)
library(RColorBrewer)
library(scico)
library(ggsci)
library(ggbeeswarm)
library(cowplot)
```


```{r, echo = FALSE}
cellranger_dir_1 <- 
    file.path("/lab-share/IM-Gutierrez-e2/Public/Lab_datasets/CITEseq_pilot", 
              "SN0231064/KW9100_Maria/210726_10X_KW9100-2_bcl/cellranger-6.0.1",
              "GRCh38/BRI-1283/outs/filtered_feature_bc_matrix")

cellranger_dir_2 <- 
    file.path("/lab-share/IM-Gutierrez-e2/Public/Lab_datasets/CITEseq_pilot_2",
	      "SN0257788/broad/hptmp/curtism/bwh10x/KW10170_Maria/220617_10X_KW10170_bcl",
	      "cellranger-6.1.1/GRCh38/BRI-1743_hashing/outs/filtered_feature_bc_matrix")

features_1_df <- file.path(cellranger_dir_1, "features.tsv.gz") %>%
    read_tsv(col_names = c("gene_id", "gene_name", "phenotype"))

features_2_df <- file.path(cellranger_dir_2, "features.tsv.gz") %>%
    read_tsv(col_names = c("gene_id", "gene_name", "phenotype"))

genes_df <- features_1_df %>%
  filter(phenotype == "Gene Expression") %>%
  select(gene_id, gene_name)

mt_genes <- genes_df %>%
    filter(grepl("^MT-", gene_name)) %>%
    pull(gene_id)

ribo_genes <- genes_df %>%
    filter(grepl("^RPS\\d+|^RPL\\d+", gene_name)) %>%
    pull(gene_id)

data10x_1 <- Read10X(cellranger_dir_1, gene.column = 1)
data10x_2 <- Read10X(cellranger_dir_2, gene.column = 1)
```

```{r, echo = FALSE}
antibody_1 <- data10x_1[["Antibody Capture"]] %>%
    .[!grepl("^Hashtag", rownames(.)), ] 

antibody_2 <- data10x_2[["Antibody Capture"]] %>%
    .[!grepl("^Hashtag", rownames(.)), ] 

rownames(antibody_1) <- rownames(antibody_1) %>%
    sub("_prot$", "", .) %>%
    gsub("_", ".", .)

rownames(antibody_2) <- rownames(antibody_2) %>%
    sub("_prot$", "", .) %>%
    gsub("_", ".", .)

hashtags_1 <- data10x_1[["Antibody Capture"]] %>%
    .[grepl("^Hashtag", rownames(.)), ]

rownames(hashtags_1) <- 
    c("BCR 72hr", "TLR7 72hr", "BCR 24hr", "TLR7 24hr", "Res 24hr", "Res 0hr")

hashtags_2 <- data10x_2[["Antibody Capture"]] %>%
    .[grepl("^Hashtag", rownames(.)), ]

rownames(hashtags_2) <- 
    c("day0", 
    "IL4 24hr",
    "BCR 24hr",
    "BCR+TLR7 24hr",
    "TLR7 24hr", 
    "sCD40L 24hr",
    "CpG 24hr",
    "DN2 24hr",
    "BCR 72hr",
    "BCR+TLR7 72hr",
    "TLR7 72hr",
    "sCD40L 72hr",
    "DN2 72hr",
    "CpG 72hr")

pilot1_stim <- rownames(hashtags_1) %>%
    str_sort(numeric = TRUE) %>%
    fct_relevel("Res 0hr", after = 0) %>%
    fct_relevel("Res 24hr", after = 1) %>%
    levels() %>%
    c("Doublet", .)

pilot2_stim <- rownames(hashtags_2) %>%
    str_sort(numeric = TRUE) %>%
    fct_relevel("day0", after = 0) %>%
    fct_relevel("IL4 24hr", after = 1) %>%
    fct_relevel("TLR7 24hr", after = 4) %>%
    fct_relevel("TLR7 72hr", after = 5) %>%
    levels() %>%
    c("Doublet", .)

pilot1_pal <- c("black", "grey", "slategrey", brewer.pal(n = 4, "Paired")) %>%
    setNames(pilot1_stim)

pilot2_pal <- c("black", "grey", "slategrey", brewer.pal(n = 12, "Paired")) %>%
    setNames(pilot2_stim)


# Create object
bcells_1 <- CreateSeuratObject(counts = data10x_1[["Gene Expression"]], project = "pilot1")
bcells_1[["ADT"]] <- CreateAssayObject(counts = antibody_1)
bcells_1[["HTO"]] <- CreateAssayObject(counts = hashtags_1)

bcells_2 <- CreateSeuratObject(counts = data10x_2[["Gene Expression"]], project = "pilot2")
bcells_2[["ADT"]] <- CreateAssayObject(counts = antibody_2)
bcells_2[["HTO"]] <- CreateAssayObject(counts = hashtags_2)

bcells_1[["percent_mt"]] <- PercentageFeatureSet(bcells_1, features = mt_genes)
bcells_1[["percent_ribo"]] <- PercentageFeatureSet(bcells_1, features = ribo_genes)

bcells_2[["percent_mt"]] <- PercentageFeatureSet(bcells_2, features = mt_genes)
bcells_2[["percent_ribo"]] <- PercentageFeatureSet(bcells_2, features = ribo_genes)

# Normalize
bcells_1_m1 <- bcells_1 %>%
  NormalizeData(normalization.method = "LogNormalize", margin = 1) %>%
  NormalizeData(assay = "HTO", normalization.method = "CLR", margin = 1) %>%
  NormalizeData(assay = "ADT", normalization.method = "CLR", margin = 2)

bcells_1_m2 <- bcells_1 %>%
  NormalizeData(normalization.method = "LogNormalize", margin = 1) %>%
  NormalizeData(assay = "HTO", normalization.method = "CLR", margin = 2) %>%
  NormalizeData(assay = "ADT", normalization.method = "CLR", margin = 2)

bcells_2_m1 <- bcells_2 %>%
  NormalizeData(normalization.method = "LogNormalize", margin = 1) %>%
  NormalizeData(assay = "HTO", normalization.method = "CLR", margin = 1) %>%
  NormalizeData(assay = "ADT", normalization.method = "CLR", margin = 2)

bcells_2_m2 <- bcells_2 %>%
  NormalizeData(normalization.method = "LogNormalize", margin = 1) %>%
  NormalizeData(assay = "HTO", normalization.method = "CLR", margin = 2) %>%
  NormalizeData(assay = "ADT", normalization.method = "CLR", margin = 2)
```

## Raw counts

```{r, echo = FALSE, fig.width = 6, fig.height = 3}
counts_df <- 
    bind_rows(bcells_1_m1@meta.data %>%
	      rownames_to_column("barcode") %>%
	      select(barcode, pilot = orig.ident, RNA = nCount_RNA, ADT = nCount_ADT, HTO = nCount_HTO),
	      bcells_2_m1@meta.data %>%
	      rownames_to_column("barcode") %>%
	      select(barcode, pilot = orig.ident, RNA = nCount_RNA, ADT = nCount_ADT, HTO = nCount_HTO)) %>%
    as_tibble() %>%
    pivot_longer(RNA:HTO, names_to = "assay", values_to = "count")

ggplot(counts_df, aes(x = pilot, y = count)) +
    geom_violin(aes(fill = pilot), show.legend = FALSE) +
    scale_y_continuous(trans = scales::pseudo_log_trans(sigma = 1, base = 10),
		       breaks = scales::log_breaks(base = 10),
		       labels = scales::comma,
		       limits = c(10, NA)) +
    scale_fill_npg() +
    facet_wrap(~assay, nrow = 1) +
    theme_bw() +
    labs(x = NULL)
```

## QC

Here we use the miQC package to model the percentage of mitochondrial reads and number of genes, in order to identify and remove compromised cells.

```{r, echo=FALSE, fig.height=4, fig.width=4, echo = FALSE}
bcells_sce_1 <- bcells_1_m1 %>%
    as.SingleCellExperiment() %>%
    addPerCellQC(subsets = list(mito = mt_genes))

model_1 <- mixtureModel(bcells_sce_1)

bcells_sce_2 <- bcells_2_m1 %>%
    as.SingleCellExperiment() %>%
    addPerCellQC(subsets = list(mito = mt_genes))

model_2 <- mixtureModel(bcells_sce_2)

qc1 <- plotFiltering(bcells_sce_1, model_1) +
    scale_x_continuous(limits = c(0, 1e4)) +
    scale_y_continuous(limits = c(0, 100)) +
    theme_bw() +
    theme(text = element_text(size = 8),
	  panel.grid.minor = element_blank()) +
    labs(title = "Pilot #1") +
    guides(color = guide_legend(override.aes = list(size = 2)))

qc2 <- plotFiltering(bcells_sce_2, model_2) +
    scale_x_continuous(limits = c(0, 1e4)) +
    scale_y_continuous(limits = c(0, 100)) +
    theme_bw() +
    theme(text = element_text(size = 8),
	  panel.grid.minor = element_blank()) +
    labs(title = "Pilot #2") +
    guides(color = guide_legend(override.aes = list(size = 2)))

qc1$layers[[1]] <- NULL
qc2$layers[[1]] <- NULL
qc1 <- qc1 + geom_point(size = .1)
qc2 <- qc2 + geom_point(size = .1)

plot_grid(qc1, qc2, nrow = 2)
```

```{r, echo = FALSE}
bcells_sce_1_filt <- filterCells(bcells_sce_1, model_1)
bcells_sce_2_filt <- filterCells(bcells_sce_2, model_2)

cells_keep_1 <- rownames(colData(bcells_sce_1_filt))
cells_keep_2 <- rownames(colData(bcells_sce_2_filt))

bcells_1_m1_qc <- subset(bcells_1_m1, cells = cells_keep_1) %>%
  subset(nFeature_RNA > 500)

bcells_1_m2_qc <- subset(bcells_1_m2, cells = cells_keep_1) %>%
  subset(nFeature_RNA > 500)

bcells_2_m1_qc <- subset(bcells_2_m1, cells = cells_keep_2) %>%
  subset(nFeature_RNA > 500)

bcells_2_m2_qc <- subset(bcells_2_m2, cells = cells_keep_2) %>%
  subset(nFeature_RNA > 500)
```

## Demultiplex cells based on HTO

```{r, echo = FALSE, fig.width = 4, fig.height = 2.5}
bcells_1_m1_qc_demux <- HTODemux(bcells_1_m1_qc, assay = "HTO", positive.quantile = 0.99)
bcells_1_m2_qc_demux <- HTODemux(bcells_1_m2_qc, assay = "HTO", positive.quantile = 0.99)
bcells_2_m1_qc_demux <- HTODemux(bcells_2_m1_qc, assay = "HTO", positive.quantile = 0.99)
bcells_2_m2_qc_demux <- HTODemux(bcells_2_m2_qc, assay = "HTO", positive.quantile = 0.99)

class_df <-
    bind_rows("Pilot1\nmargin=1" = bcells_1_m1_qc_demux@meta.data,
	      "Pilot1\nmargin=2" = bcells_1_m2_qc_demux@meta.data,
	      "Pilot2\nmargin=1" = bcells_2_m1_qc_demux@meta.data,
	      "Pilot2\nmargin=2" = bcells_2_m2_qc_demux@meta.data,
	      .id = "id") %>%
    rownames_to_column("barcode") %>%
    as_tibble() %>%
    select(id, barcode, classification = HTO_classification.global,
	   RNA = nCount_RNA, ADT = nCount_ADT, HTO = nCount_HTO) 

class_df %>%
    count(id, classification) %>%
    ggplot(aes(id, n, fill = classification)) +
	geom_bar(position = "fill", stat = "identity", color = "black", size = .25) +
	scale_y_continuous(labels = scales::percent) +
	scale_fill_manual(values = c("Negative" = "white",
				     "Singlet" = "grey40",
				     "Doublet" = "Black")) +
	theme_bw() +
	theme(axis.text.x = element_text(size = 8)) +
	labs(x = NULL, y = "Frequency", fill = NULL)
```

```{r, echo=FALSE, fig.height = 3, fig.width = 6}
class_df2 <- class_df %>%
    select(1:3) %>%
    separate(id, c("pilot", "margin"), sep = "\n") %>%
    mutate(barcode = sub("\\.+\\d+$", "", barcode)) %>%
    group_by(pilot) %>%
    pivot_wider(names_from = margin, values_from = classification) %>%
    ungroup() %>%
    mutate_at(vars(3:4), ~factor(., levels = c("Negative", "Singlet", "Doublet")))

class_df2 %>%
    count(pilot, `margin=1`, `margin=2`) %>%
    ggplot(aes(x = `margin=1`, y = `margin=2`)) +
    geom_point(aes(fill = n, size = n),  
	       shape = 21, alpha = .5,
	       show.legend = FALSE) +
    geom_text(aes(label = n)) +
    scale_size(range = c(8, 30)) +
    scale_fill_gradient(low = "white", high = "red") +
    facet_wrap(~pilot) +
    theme_bw() +
    theme(panel.grid = element_blank())
```

```{r, echo=FALSE, fig.width=10, fig.height=3}
class_df %>%
    pivot_longer(RNA:HTO) %>%
    mutate_at(vars(classification), ~factor(., levels = c("Negative", "Singlet", "Doublet"))) %>%
    ggplot(aes(x = id, y = value)) +
    geom_violin(aes(fill = classification), size = .25) +
    facet_wrap(~name, scales = "free_y") +
    scale_y_continuous(trans = scales::pseudo_log_trans(sigma = 1, base = 10),
		       breaks = scales::log_breaks(base = 10),
		       labels = scales::comma) +
    scale_fill_manual(values = c("Negative" = "white",
				 "Singlet" = "grey40",
				 "Doublet" = "Black")) +
    theme_bw() +
    theme(axis.text.x = element_text(size = 6)) +
    labs(x = NULL, y = "Count", fill = NULL)
```

In the plot above, we see 2 differences between pilots 1 and 2:

- In pilot 1, HTO counts in higher, including for those cells being classified as "Negatives";

- In pilot 2, HTO counts for doublets not that higher than those for singlets.

Regarding the last point, doublets don't necessarily have higher counts, but a mixture of HTOs.

However, a lot of droplets being classified as doublets in pilot 2 have a profile resembling singlets in respect to the mixture of HTO, as we can see in the plots below.

```{r, fig.width = 10, fig.height = 20}
plot_admix <- function(seurat_obj, stim_colors) {

    meta_df <- seurat_obj@meta.data %>%
	as_tibble(rownames = "barcode") %>%
	select(barcode, stim = HTO_maxID, hto_class = HTO_classification.global)
  
    hto_df <- seurat_obj@assays$HTO@counts %>%
	as_tibble(rownames = "hto") %>%
	pivot_longer(-hto, names_to = "barcode") %>%
	left_join(meta_df)

    hto_top <- hto_df %>%
	group_by(barcode, hto_class) %>%
	slice_max(n = 1, order_by = value) %>%
	select(barcode, hto_class, top_hto = hto) %>%
	ungroup()

    hto_plot_df <- hto_df %>%
	left_join(hto_top, by = c("barcode", "hto_class")) %>%
	mutate_at(vars(top_hto, stim), ~factor(., levels = names(stim_colors)))

    ggplot(hto_plot_df, aes(reorder_within(barcode, by = value, within = stim), value)) +
    geom_col(aes(fill = hto), position = "fill", width = 1.01, show.legend = FALSE) +
    scale_fill_manual(values = stim_colors) +
    facet_grid(~stim, scales = "free_x", space = "free") +
    theme_bw() +
    theme(axis.text.x = element_blank(),
	  axis.ticks.x = element_blank(),
	  axis.line = element_blank(),
	  panel.grid = element_blank(),
	  panel.border = element_blank(),
	  strip.text = element_blank()) +
    labs(x = NULL, y = NULL)
}

Idents(bcells_1_m1_qc_demux) <- "HTO_classification.global"
Idents(bcells_1_m2_qc_demux) <- "HTO_classification.global"
Idents(bcells_2_m1_qc_demux) <- "HTO_classification.global"
Idents(bcells_2_m2_qc_demux) <- "HTO_classification.global"


admix_1 <- plot_admix(subset(bcells_1_m1_qc_demux, idents = "Singlet"), pilot1_pal) +
    labs(title = "Pilot 1: Singlets", subtitle = "margin = 1")

admix_2 <- plot_admix(subset(bcells_1_m2_qc_demux, idents = "Singlet"), pilot1_pal) +
    labs(title = "Pilot 1: Singlets", subtitle = "margin = 2")

admix_3 <- plot_admix(subset(bcells_1_m1_qc_demux, idents = "Doublet"), pilot1_pal) +
    labs(title = "Pilot 1: Doublets", subtitle = "margin = 1")

admix_4 <- plot_admix(subset(bcells_1_m2_qc_demux, idents = "Doublet"), pilot1_pal) +
    labs(title = "Pilot 1: Doublets", subtitle = "margin = 2")

admix_5 <- plot_admix(subset(bcells_2_m1_qc_demux, idents = "Singlet"), pilot2_pal) +
    labs(title = "Pilot 2: Singlets", subtitle = "margin = 1")

admix_6 <- plot_admix(subset(bcells_2_m2_qc_demux, idents = "Singlet"), pilot2_pal) +
    labs(title = "Pilot 2: Singlets", subtitle = "margin = 2")

admix_7 <- plot_admix(subset(bcells_2_m1_qc_demux, idents = "Doublet"), pilot2_pal) +
    labs(title = "Pilot 2: Doublets", subtitle = "margin = 1")

admix_8 <- plot_admix(subset(bcells_2_m2_qc_demux, idents = "Doublet"), pilot2_pal) +
    labs(title = "Pilot 2: Doublets", subtitle = "margin = 2")

plot_grid(admix_1, admix_2, admix_3, admix_4, admix_5, admix_6, admix_7, admix_8, ncol = 1)

```


```{r, echo=FALSE, fig.height = 6, fig.width = 8}
bcells_1_m1_noneg <- subset(bcells_1_m1_qc_demux, idents = "Negative", invert = TRUE)
bcells_1_m2_noneg <- subset(bcells_1_m2_qc_demux, idents = "Negative", invert = TRUE)
bcells_2_m1_noneg <- subset(bcells_2_m1_qc_demux, idents = "Negative", invert = TRUE)
bcells_2_m2_noneg <- subset(bcells_2_m2_qc_demux, idents = "Negative", invert = TRUE)

DefaultAssay(bcells_1_m1_noneg) <- "HTO"
DefaultAssay(bcells_1_m2_noneg) <- "HTO"
DefaultAssay(bcells_2_m1_noneg) <- "HTO"
DefaultAssay(bcells_2_m2_noneg) <- "HTO"

bcells_1_m1_noneg <- bcells_1_m1_noneg %>%
    ScaleData(., features = rownames(.), verbose = FALSE) %>%
    RunPCA(., features = rownames(.), approx = FALSE, verbose = FALSE) %>%
    RunUMAP(., dims = 1:length(rownames(.)), verbose = FALSE)

bcells_1_m2_noneg <- bcells_1_m2_noneg %>%
    ScaleData(., features = rownames(.), verbose = FALSE) %>%
    RunPCA(., features = rownames(.), approx = FALSE, verbose = FALSE) %>%
    RunUMAP(., dims = 1:length(rownames(.)), verbose = FALSE)

bcells_2_m1_noneg <- bcells_2_m1_noneg %>%
    ScaleData(., features = rownames(.), verbose = FALSE) %>%
    RunPCA(., features = rownames(.), approx = FALSE, verbose = FALSE) %>%
    RunUMAP(., dims = 1:length(rownames(.)), verbose = FALSE)

bcells_2_m2_noneg <- bcells_2_m2_noneg %>%
    ScaleData(., features = rownames(.), verbose = FALSE) %>%
    RunPCA(., features = rownames(.), approx = FALSE, verbose = FALSE) %>%
    RunUMAP(., dims = 1:length(rownames(.)), verbose = FALSE)


make_umap_df <- function(x) {
    umap_df <- x@reductions$umap@cell.embeddings %>%
	as_tibble(rownames = "barcode")

    meta_df <- as_tibble(x@meta.data, rownames = "barcode") %>% 
	select(barcode, clas = HTO_classification.global, stim = HTO_maxID)

    left_join(umap_df, meta_df, by = "barcode")
}

umap_dat <- bind_rows(
    "Pilot 1, Margin = 1" = make_umap_df(bcells_1_m1_noneg),
    "Pilot 1, Margin = 2" = make_umap_df(bcells_1_m2_noneg),
    "Pilot 2, Margin = 1" = make_umap_df(bcells_2_m1_noneg),
    "Pilot 2, Margin = 2" = make_umap_df(bcells_2_m2_noneg),
    .id = "set"
)


umap_p1 <- umap_dat %>%
    filter(grepl("Pilot 1", set)) %>%
    mutate(lab = ifelse(clas == "Doublet", clas, stim)) %>%
    ggplot(aes(UMAP_1, UMAP_2)) +
    geom_point(aes(color = lab), size = .25) +
    scale_color_manual(values = pilot1_pal) +
    facet_wrap(~set, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(panel.grid = element_blank(),
	  axis.title = element_text(size = 8)) +
    guides(color = guide_legend(override.aes = list(size = 4))) +
    labs(color = NULL)

umap_p2 <- umap_dat %>%
    filter(grepl("Pilot 2", set)) %>%
    mutate(lab = ifelse(clas == "Doublet", clas, stim)) %>%
    ggplot(aes(UMAP_1, UMAP_2)) +
    geom_point(aes(color = lab), size = .25) +
    scale_color_manual(values = pilot2_pal) +
    facet_wrap(~set, ncol = 2, scales = "free") +
    theme_minimal() +
    theme(panel.grid = element_blank(),
	  axis.title = element_text(size = 8),
	  legend.key.height = unit(.75, "lines")) +
    guides(color = guide_legend(override.aes = list(size = 4))) +
    labs(color = NULL)

plot_grid(plot_grid(umap_p1 + theme(legend.position = "none"), get_legend(umap_p1), nrow = 1, rel_widths = c(1, .25)),
	  plot_grid(umap_p2 + theme(legend.position = "none"), get_legend(umap_p2), nrow = 1, rel_widths = c(1, .25)),
	  ncol = 1)
```

So, Seurat might be doing a good job in classifying Singlets. For exemple, see the plot below for Pilot 1, margin = 2.

```{r, fig.width=6, fig.height=4}
hto_counts <- bcells_1_m2_qc_demux@assays$HTO@counts %>%
    as_tibble(rownames = "hto") %>%
    pivot_longer(-hto, names_to = "barcode", values_to = "count") %>%
    left_join(as_tibble(bcells_1_m2_qc_demux@meta.data, rownames = "barcode") %>%
              select(barcode, hto_max = HTO_maxID, hto_class = HTO_classification.global)) %>%
    mutate_at(vars(hto_max, hto), ~factor(., levels = pilot1_stim)) %>%
    mutate(hto_class = factor(hto_class, levels = c("Singlet", "Doublet", "Negative"))) %>%
    arrange(hto_class, hto, hto_max) %>%
    mutate(logcount = ifelse(count > 0, log10(count), 0))

hto_counts %>%
    filter(hto_class == "Singlet") %>%
    ggplot(aes(x = hto, y = logcount)) +
    geom_violin(aes(fill = hto), size = .25) +
    geom_quasirandom(data = filter(hto_counts, hto_class == "Negative"),
                     method = "smiley", groupOnX = TRUE,
                     shape = 21, fill = NA, size = .5, width = .25) +
    scale_fill_manual(values = pilot1_pal) +
    facet_wrap(~hto_max, nrow = 2) +
    theme_bw() +
    theme(axis.text.x = element_blank(),
          axis.title.x = element_blank(),
	  axis.ticks.x = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.y = element_blank()) +
    labs(y = "Log10(count)",
         fill = "HTO", 
         title = "Distribution of all HTO counts for singlets in each condition",
         subtitle = "Points represent droplets classified as Negatives")
```


Let's take a look at the clustering performed by Seurat to classify cells.


```{r, fig.width=8, fig.height= 10}
plot_clusters <- function(seurat_obj, stim_colors) {
    
    DefaultAssay(seurat_obj) <- "HTO"
    
    seurat_obj <- seurat_obj %>%
	ScaleData(., features = rownames(.), verbose = FALSE) %>%
	RunPCA(., features = rownames(.), approx = FALSE, verbose = FALSE)

    hto_k <- clara(t(seurat_obj@assays$HTO@data), nrow(seurat_obj) + 1, samples = 100)
    kmeans_df <- tibble(barcode = names(hto_k$clustering),
			cluster = hto_k$clustering)

    p1 <- seurat_obj@reductions$pca@cell.embeddings %>%
	as_tibble(rownames = "barcode") %>%
	left_join(kmeans_df) %>%
	ggplot(aes(PC_1, PC_2, color = factor(cluster))) +
	geom_point(size = .75) +
	scale_color_manual(values = pals::kelly(n = nrow(seurat_obj) + 1)) +
	theme_bw() +
	theme(panel.grid = element_blank()) +
	guides(color = guide_legend(override.aes = list(size = 2))) +
	labs(color = "Cluster")

    p2 <- seurat_obj@reductions$pca@cell.embeddings %>%
	as_tibble(rownames = "barcode") %>%
	left_join(as_tibble(seurat_obj@meta.data, rownames = "barcode") %>%
		  select(barcode, hto_class = HTO_classification) %>%
		  mutate(hto_class = ifelse(grepl("_", hto_class), "Doublet", hto_class))) %>%
	ggplot(aes(PC_1, PC_2, color = hto_class)) +
	geom_point(size = .75) +
	scale_color_manual(values = c(stim_colors, "Negative" = "red")) +
	theme_bw() +
	theme(panel.grid = element_blank()) +
	guides(color = guide_legend(override.aes = list(size = 2))) +
	labs(color = "HTO\nclassification")

    plot_grid(p1, p2, nrow = 1)
}

plot_grid(plot_clusters(bcells_1_m1_qc_demux, pilot1_pal) +
	  labs(title = "Pilot 1, margin = 1"),
      plot_clusters(bcells_1_m2_qc_demux, pilot1_pal) +
	  labs(title = "Pilot 1, margin = 2"),
      plot_clusters(bcells_2_m1_qc_demux, pilot2_pal) +
	  labs(title = "Pilot 2, margin = 1"),
      plot_clusters(bcells_2_m2_qc_demux, pilot2_pal) +
	  labs(title = "Pilot 2, margin = 2"),
      ncol = 1)
```


## Alternative demultiplex algorithm

- Cells with total HTO counts < 20 times the number of different hashtags = "Negatives";

- Cells with a dominant hashtag (75% of total counts) = "Singlets";

- Cells with a mixture = "Doublets"


```{r}
custom_class_pilot1 <- bcells_1_m1_qc_demux@assays$HTO@counts %>%
    as_tibble(rownames = "hto") %>%
    pivot_longer(-hto, names_to = "barcode", values_to = "count") %>%
    group_by(barcode) %>%
    mutate(pct = count/sum(count)) %>%
    summarise(hto_class = case_when(sum(count) < n_distinct(hto) * 20 ~ "Negative",
				    sum(count) >= n_distinct(hto) * 20 & any(pct >= .75) ~ "Singlet",
				    sum(count) >= n_distinct(hto) * 20 & !any(pct >= .75) ~ "Doublet",
				    TRUE ~ NA_character_)) %>%
    ungroup()

custom_class_pilot2 <- bcells_2_m1_qc_demux@assays$HTO@counts %>%
    as_tibble(rownames = "hto") %>%
    pivot_longer(-hto, names_to = "barcode", values_to = "count") %>%
    group_by(barcode) %>%
    mutate(pct = count/sum(count)) %>%
    summarise(hto_class = case_when(sum(count) < n_distinct(hto) * 20 ~ "Negative",
				    sum(count) >= n_distinct(hto) * 20 & any(pct >= .75) ~ "Singlet",
				    sum(count) >= n_distinct(hto) * 20 & !any(pct >= .75) ~ "Doublet",
				    TRUE ~ NA_character_)) %>%
    ungroup()
```

```{r, eval=FALSE}
write_tsv(custom_class_pilot1, "./custom_class_pilot1.tsv")
write_tsv(custom_class_pilot2, "./custom_class_pilot2.tsv")
```


Comparison of the number of cells after QC:

```{r}
list(
     "Pilot 1, margin=1" = count(meta_1_1, hto_class),
     "Pilot 1, margin=2" = count(meta_1_2, hto_class),
     "Pilot 2, margin=1" = count(meta_2_1, hto_class),
     "Pilot 2, margin=2" = count(meta_2_2, hto_class),
     "Pilot 1, Alternative" = count(custom_class_pilot1, hto_class),
     "Pilot 2, Alternative" = count(custom_class_pilot2, hto_class)) %>%
bind_rows(.id = "set") %>%
pivot_wider(names_from = hto_class, values_from = n)
```



