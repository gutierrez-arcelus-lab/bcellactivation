---
title: "README"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, dpi = 300)
```

## Packages

```{r}
library(tidyverse)
library(ggsci)
library(ggrepel)
```

## Functions

```{r}
read_leaf <- function(cell_type) {
    
    sig <- 
        file.path("./results", cell_type, "leafcutter_cluster_significance.txt") %>%
        read_tsv() %>%
        separate(cluster, c("chr", "cluster"), sep = ":") %>%
        select(cluster, p.adjust, genes)

    eff <- 
        file.path("./results", cell_type, "leafcutter_effect_sizes.txt") %>%
        read_tsv() %>%
        mutate(cluster = sub("^.*(clu.*)$", "\\1", intron)) %>%
        select(cluster, logef, deltapsi)

    inner_join(sig, eff)
}
```


```{r}
cell_types <- list.files("results") %>%
    .[!. %in% "PbPc"] %>%
    setNames(., .)

leaf_df <- map_df(cell_types, read_leaf, .id = "cell_type") %>%
    group_by(cell_type, cluster) %>%
    slice(which.min(p.adjust)) %>%
    ungroup()
```

```{r, echo = FALSE, fig.height=14}
labs_df <- leaf_df %>%
    filter(p.adjust < 0.05) %>%
    mutate(weight = deltapsi * -log10(p.adjust)) %>%
    group_by(cell_type) %>%
    top_n(30, abs(weight)) %>%
    ungroup() %>%
    mutate(gene_label = str_trunc(genes, 10))

ggplot(leaf_df, aes(deltapsi, -log10(p.adjust))) +
    geom_point(aes(color = p.adjust < .05), show.legend = FALSE) +
    geom_text_repel(data = labs_df, aes(label = gene_label),
                    size = 2.5) +
    scale_color_npg() +
    scale_x_continuous(limits = c(-.75, .75)) +
    facet_wrap(~cell_type, ncol = 1, scales = "free") +
    theme_bw() +
    theme(panel.grid = element_blank()) +
    labs(x = "Delta PSI", 
         y = "-log10(p-value)",
         color = "Significant?")
```


