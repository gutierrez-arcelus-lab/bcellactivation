---
title: "README"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, dpi = 300)
```

## Packages

```{r}
library(tidyverse)
library(tidytext)
library(ggsci)
library(ggrepel)
library(cowplot)
```

## Functions

```{r}
read_leaf <- function(cell_type) {
    
    sig <- 
        file.path("./results", cell_type, "leafcutter_cluster_significance.txt") %>%
        read_tsv() %>%
        separate(cluster, c("chr", "cluster"), sep = ":") %>%
        select(cluster, p.adjust, genes)

    eff <- 
        file.path("./results", cell_type, "leafcutter_effect_sizes.txt") %>%
        read_tsv() %>%
        mutate(cluster = sub("^.*(clu.*)$", "\\1", intron)) %>%
        select(cluster, logef, deltapsi)

    inner_join(sig, eff)
}
```


```{r}
cell_types <- c("rN", "aN", "T3", "SM", "DN") %>%
    setNames(., .)

leaf_df <- map_df(cell_types, read_leaf, .id = "cell_type") %>%
    group_by(cell_type, cluster) %>%
    slice(which.max(abs(deltapsi))) %>%
    ungroup()
```



```{r, echo = FALSE, fig.height=14, fig.width=7}
labs_df <- leaf_df %>%
    filter(p.adjust < 0.05) %>%
    mutate(weight = deltapsi * -log10(p.adjust)) %>%
    group_by(cell_type) %>%
    top_n(30, abs(weight)) %>%
    ungroup() %>%
    mutate(gene_label = str_trunc(genes, 10))

ggplot(leaf_df, aes(deltapsi, -log10(p.adjust))) +
    geom_point(aes(color = p.adjust < .05), size = .7, show.legend = FALSE) +
    geom_text_repel(data = labs_df, aes(label = gene_label),
                    size = 2.5) +
    scale_color_npg() +
    scale_x_continuous(limits = c(-.75, .75)) +
    facet_wrap(~cell_type, ncol = 1, scales = "free") +
    theme_bw() +
    theme(panel.grid = element_blank()) +
    labs(x = "Delta PSI", 
         y = "-log10(p-value)",
         color = "Significant?")
```

## GO enrichment

GO enrichment analysis on genes with at least one cluster with absolute delta PSI > 0.1.


```{r}
go <- read_tsv("./results/enrichment.tsv") %>%
    arrange(Description)
```


```{r, echo = FALSE, fig.height=7, fig.width=8}
go_top15 <- go %>%
    group_by(cell_type) %>%
    top_n(15, -log10(qvalue)) %>%
    ungroup() %>%
    filter(cell_type != "T3") %>%
    mutate(cell_type = factor(cell_type, levels = c("rN", "aN", "SM", "DN"))) %>%
    arrange(cell_type, qvalue)

goterms <- distinct(go_top15, Description) %>%
    pull(Description)

go_plot <- go_top15 %>%
    mutate(Description = factor(Description, levels = rev(goterms))) %>%
    ggplot(aes(cell_type, Description)) +
        geom_point(aes(size = Count, fill = -log10(qvalue)), shape = 21) +
        scale_fill_viridis_c(option = "magma") +
        theme_minimal() +
        theme(axis.title = element_blank(),
              legend.position = "top") +
        labs(size = "# Genes:") +
        guides(fill = guide_colorbar(direction = "horizontal", barheight = 0.5),
               size = guide_legend(direction = "horizontal"))

plot_grid(get_legend(go_plot), 
          go_plot + theme(legend.position = "none"),
          ncol = 1,
          rel_heights = c(0.1, 1))
             
```




